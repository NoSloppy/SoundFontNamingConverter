<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sound Font Naming Converter</title>

    <link rel="icon" type="image/png" href="/favicon.png">
</head>
    <style>

body, html {
    background-color: #202020;
    color: #FFFFFF;
    font-family: Arial, sans-serif;
}
input, select, button {
    background-color: #555;
    color: #fff;
    border: 1px solid #777;
    border-radius: 2px;
}
progress {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
    border: 1px solid #00AA00;
}
progress::-webkit-progress-bar {
    background: #222;
}
progress::-webkit-progress-value {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
}
progress::-moz-progress-bar {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
}
.uploadProgressBar {
    width: 50%;
}
button:active,
input[type="button"]:active,
input[type="submit"]:active,
input[type="file"]:active + label {
background-color: dodgerblue;
}

button:hover,
input[type="button"]:hover,
input[type="submit"]:hover,
input[type="file"]:hover + label {
    box-shadow: 0 0 2px 1px dodgerblue;
}

h1 {
  text-align: center;
}


.downloadButton {
    display: none;
}

/* Footer */
.footer-title {
    min-width: 180px;
    font-size: 16px;
    padding-left: 10px;
}
.footer-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #333;
    padding: 6px 0px;
}
.other-sites {
    float: right;
    padding-right: 10px;
    margin-left: 35px;
}
.footer-links {
    display: flex;
    align-items: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 100px;
}
.footer-links a img {
    height: 16px;
    width: 16px;
/*    margin-right: 5px;*/
    padding-right: 10px;

}
.footer-links a:hover {
    color: #000;
}
.donate-button {
  width: 170px;
  height: auto;
}
    </style>
<body>
    <h1>Welcome to the Sound Font Naming Converter 3.0</h1>
    <p>1. Choose a source and target format from the drop down menus below.</p>

    <!-- Message display for feedback -->
    <div th:if="${message}" th:text="${message}"></div>


    <!-- Form to get user input -->
    <form id="uploadForm" action="/convert" method="post" enctype="multipart/form-data">
        <!-- Dropdown for source board selection -->
        <select id="sourceBoard" name="sourceBoard" title="Source board">
            <option value="CFX">CFX</option>
            <option value="GH3">GH3</option>
            <option value="PROFFIE">PROFFIE</option>
            <option value="VERSO">VERSO</option>
            <option value="XENO3">XENO3</option>
        </select>

        <!-- Dropdown for target board selection -->
        <select id="targetBoard" name="targetBoard" title="Target board">
            <option value="CFX">CFX</option>
            <option value="GH3">GH3</option>
            <option value="PROFFIE">PROFFIE</option>
            <option value="VERSO">VERSO</option>
            <option value="XENO3">XENO3</option>
        </select>

        <input type="checkbox" id="optimizeForProffie" name="optimizeForProffie" value="true" checked>
        <label for="optimizeForProffie">Optimize for FAT32 performance? You should ;)</label>
        <br>
        <br>
        <br>
        <div>
            <button id="proffieOptimizerButton" type="button" class="proffieOptimizerButton"
            title="Reorganizes an existing Proffie font for best performance. Just choose a source folder and the process is automated. Save downloaded file."> Proffie Easy Optimizer </button>
        </div>


        <br>

        <p>2. Add the font folder you wish to convert.</p>

        <!-- Directory input -->
        <div>
            <input type="file" id="files" name="files" webkitdirectory directory multiple>
        </div>
        <br>

        <p>3. Click "Convert" and then Download the resulting zip file to your computer.</p>

        <!-- Convert button -->
        <input type="submit" value="Convert" id="convertInput" title="Convert selected font folder." >

        <!-- Progress bar and its status message -->
        <div>
        <br>
            <p>Progress....</p>
            <progress id="uploadProgressBar" class="uploadProgressBar" max="100" value="0" ></progress>
            <p id="progressStatus">Waiting for files to be uploaded. Choose Files and click 'Convert'.</p>
        </div>

        <!-- Download button (Hidden initially) -->
        <button id="downloadButton" type="button" class="downloadButton" title="Download converted font." >Download Converted Files</button>

        <div class="footer-container">
          <span class="footer-title">NoSloppy - 2023</span>

        <a href="https://www.buymeacoffee.com/BrianConner" title="Brian Conner supports the saber community. Support him back.">
            <img class="donate-button" src="/donateButton.jpg"></a>

          <span class="footer-links">
            <span class="other-sites">Other sites: </span>
            <a href="https://crucible.hubbe.net/" target="_blank" title="The Crucible"><img src="https://crucible.hubbe.net/uploads/default/optimized/1X/2237f551ca8f4f69ac478df5c64aee1c951c33f5_2_180x180.png" alt="Crucible logo"></a>
            <a href="https://pod.hubbe.net/" target="_blank" title="ProffieOS Documentation site" ><img src="https://pod.hubbe.net/images/favicon.png" alt="Pod logo"></a>
            <a href="https://fredrik.hubbe.net/lightsaber/" target="_blank" title="Profezzorn's Proffieboard site"><img src="https://fredrik.hubbe.net/favicon.ico" alt="Lightsaber logo"></a>
            <a href="https://www.fett263.com/" target="_blank" title="Fett263's Style Library"><img src="https://www.fett263.com//favicon.ico" alt="Fett263 logo"></a>
            <a href="https://www.facebook.com/groups/opensourcesabers/" target="_blank" title="Open Source Group"><img src="https://www.facebook.com/favicon.ico" alt="Facebook logo"></a>
          </span>
        </div>
    </form>
<script>
    let isEasyOptimizeActive = false;
    const sourceBoard = document.getElementById('sourceBoard');
    const targetBoard = document.getElementById('targetBoard');
    const proffieOptimizerButton = document.getElementById('proffieOptimizerButton');
    const optimizeCheckbox = document.getElementById('optimizeForProffie');
    const fileInput = document.getElementById('files');
    const downloadButton = document.getElementById('downloadButton');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressStatus = document.getElementById('progressStatus');
    const form = document.getElementById('uploadForm');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
        toggleOptimizeCheckbox();
    });

    targetBoard.addEventListener('change', function() {
        toggleOptimizeCheckbox();
        resetMessage();
    });

    sourceBoard.addEventListener('change', function() {
        fileInput.value = '';
        resetMessage();
    });

    proffieOptimizerButton.addEventListener('click', function() {
        proffieOptimizerButton.style.backgroundColor = 'dodgerblue';
        hideDownloadButton();
        isEasyOptimizeActive = true;
        fileInput.click();
    });

    fileInput.addEventListener('mousedown', function(event) {
        const selectedFiles = fileInput.files;
        const convertButton = document.getElementById('convertInput');
        checkIfBoardsAreSame(event);
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length === 0) {
            isEasyOptimizeActive = false; // Reset the flag
            alert("No files selected. Please choose files before starting the conversion.");
        } else if (isEasyOptimizeActive && this.files.length > 0) {
            proffieOptimizerButton.style.backgroundColor = '#555';
            sourceBoard.value = "PROFFIE";
            targetBoard.value = "PROFFIE";
            optimizeCheckbox.checked = true;

            setTimeout(() => {
                const event = new Event('submit', {
                    'bubbles': true,
                    'cancelable': true
                });
                form.dispatchEvent(event);
            }, 100);
        }
    });

function triggerDownload(targetBoard) {
    const wasEasyOptimizeActive = isEasyOptimizeActive;  // Capture value here
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/downloadConvertedFiles?targetBoard=${targetBoard}`, true);
    xhr.responseType = 'blob';

    xhr.onload = function() {
        if (this.status === 200) {
            const blob = this.response;
            const a = document.createElement('a');
            const url = window.URL.createObjectURL(blob);

            a.href = url;
            if (wasEasyOptimizeActive) {
                a.download = `Optimized_for_PROFFIE.zip`;
            } else {
                a.download = `Converted_to_${targetBoard.toUpperCase()}.zip`;
            }
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            // Delay the reset of the UI elements by 2 seconds
            setTimeout(() => {
                progressStatus.innerText = "Conversion complete.";
                if (isEasyOptimizeActive) {
                    proffieOptimizerButton.style.backgroundColor = '#555';
                } else {
                    downloadButton.style.backgroundColor = '#555';
                }
            }, 2000);  // 2000 milliseconds = 2 seconds
        } else {
            console.error('Failed to download file:', this.status, this.statusText);
        }
    };

    xhr.send();
}

    form.addEventListener('submit', function(event) {
        console.log("Form is being submitted. isEasyOptimizeActive:", isEasyOptimizeActive);
        const selectedFiles = fileInput.files;

    if (selectedFiles.length === 0) {
        isEasyOptimizeActive = false; // Reset the flag
        alert("No files selected. Please choose files before starting the conversion.");
        event.preventDefault();
        return;
    }

        event.preventDefault();
        const formData = new FormData(form);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/convert', true);
        xhr.setRequestHeader("Accept", "application/json");

        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                progressBar.value = percentComplete;

                if (percentComplete < 100) {
                    progressStatus.innerText = "Uploading files...";
                } else {
                    progressStatus.innerText = "Files uploaded. Processing...";
                    // Reset the progress bar and simulate conversion progress
                    setTimeout(function() {
                        progressBar.value = 0;
                        simulateConversionProgress();
                    }, 500);
                }
            }
        };

        function simulateConversionProgress() {
            let value = 0;
            progressBar.interval = setInterval(function() {  // Store the interval ID on the progressBar object
                if (value >= 100) {
                    clearInterval(progressBar.interval);
                    return;
                }
                value++;
                progressBar.value = value;
                if (value === 100) {
                    progressStatus.innerText = "Conversion complete.";
                }
            }, 50);  // this will complete the progress bar in 5 seconds. Adjust as needed.
        }

        xhr.onload = function() {
            const response = JSON.parse(this.responseText);
            clearInterval(progressBar.interval);
            
            if (response.status === "success") {
                progressBar.value = 100;
                progressStatus.innerText = "Conversion complete.";
                if (!isEasyOptimizeActive) {
                    downloadButton.style.display = 'block';
                }
                else {
                    const targetBoardValue = targetBoard.value;
                    progressStatus.innerText = `Conversion complete. Standby for auto download of Optimized_for_PROFFIE.zip`;
                    triggerDownload(targetBoardValue);
                }
            } else if (response.status === "info") {
                console.log('Response was info');
                progressStatus.innerText = response.message;
                downloadButton.style.display = 'none';
            } else {
                console.log('Response was something else');
                progressStatus.innerText = response.message;
                downloadButton.style.display = 'none';
            }
            
            isEasyOptimizeActive = false;
        };

        xhr.send(formData);
    });


    downloadButton.addEventListener('click', function() {
        // Change button text upon clicking
        progressStatus.innerText = "Fetching converted files. Standby for .zip download ...";
        downloadButton.style.backgroundColor = 'dodgerblue';
        
        const targetBoardValue = targetBoard.value;  // store this for later
        triggerDownload(targetBoardValue);

    });


    function checkIfBoardsAreSame() {
            if (sourceBoard.value === "CFX" && (targetBoard.value === "PROFFIE" || targetBoard.value === "GH3")) {
                let confirmAction;
                if (targetBoard.value === "PROFFIE") {
                    confirmAction = window.confirm("Conversion from CFX to PROFFIE is not required.\nProffieboards already natively support Plecter fonts.\nDo you want to continue anyway?");
                    if (confirmAction) {
                        // Manually open the file dialog since we previously blocked it
                        fileInput.click();
                    } else {
                        toggleOptimizeCheckbox();
                    }
                } else if (targetBoard.value === "GH3") {
                    window.alert("Conversion from CFX to GH3 is unsupported.\nGH3 already natively supports Plecter fonts.");
                }
            } else if (sourceBoard.value === targetBoard.value) {
                if (sourceBoard.value === "PROFFIE") {
                    window.alert("You've chosen Proffie to Proffie, which is for the purpose of optimizing the folder structure for best performance when using a FAT32 file system (which is what the SD card uses.)");
                    optimizeCheckbox.checked = true;
                    optimizeCheckbox.disabled = true;
                } else {
                    window.alert("Conversion from " + sourceBoard.value + " to " + targetBoard.value + " is unnecessary.\nPlease choose a different conversion.");
                }
            } else {
            // Re-enable the checkbox if both boards are not Proffie
                optimizeCheckbox.disabled = false;
            }
    }

    function resetMessage() {
        hideDownloadButton();
        progressBar.value = 0;
        progressStatus.innerText = "Waiting for files to be uploaded. Choose Files and click 'Convert'.";
    }

    function hideDownloadButton() {
            downloadButton.style.display = 'none';
    }

    function toggleOptimizeCheckbox() {
            var optimizeLabel = document.querySelector('label[for="optimizeForProffie"]');

            if (targetBoard.value === "PROFFIE") {
                optimizeCheckbox.style.display = 'inline-block';
                optimizeLabel.style.display = 'inline-block';
            } else {
                optimizeCheckbox.style.display = 'none';
                optimizeLabel.style.display = 'none';
            }
    }
</script>

</body>
</html>


 <!-- 9-29 PM. ready to add Proffie Optimizer button. -->