<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sound Font Naming Converter</title>

    <link rel="icon" type="image/png" href="/favicon.png">
</head>
    <style>
@keyframes backgroundColorChange {
  0% { background-color: #340000; }
  50% { background-color: #010133; }
  100% { background-color: #340000; }
}
/* Version Popup container styling */
.popup {
    position: fixed;
    top: 27%;
    left: 50%;
    transform: translate(-50%, -20%);
    background-color: black;
    color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    width: 60%;
    max-width: 95%;
    max-height: 70%;
    overflow-y: auto;
    box-sizing: border-box;
    transition: opacity 0.25s ease-in-out;
    display: none;
}

.hidden {
    display: none;
}
.popup.show {
    display: block;
}

body {
  animation-name: backgroundColorChange;
  animation-duration: 60s;
  animation-iteration-count: infinite;
}
body, html {
    background-color: #202020;
    color: #FFFFFF;
    font-family: Arial, sans-serif;
    height: 100%; /* Full height of the viewport */
    margin: 0;
    padding: 0;
    overflow: hidden; /* Prevent scrolling on the body */
}
input, select, button {
    background-color: #555;
    color: #fff;
    border: 1px solid #777;
    border-radius: 2px;
}
progress {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
    border: 1px solid #00AA00;
}
progress::-webkit-progress-bar {
    background: #222;
}
progress::-webkit-progress-value {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
}
progress::-moz-progress-bar {
    background: linear-gradient(to bottom, #FFFFFF, #00FF00);
}
.content-container {
    overflow-y: auto; /* Enable vertical scrolling */
    height: calc(100% - 60px); /* Adjust this value based on the actual height of your footer */
    margin-left: 20px;
}
/* Make page elements like buttons and whitespace non-selectable with drag box */
* {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.uploadProgressBar {
    width: 49%;
}
.processProgressBar {
    width: 49%;
}
.audioProcessProgressBar {
    width: 95%;
}
button:active,
input[type="button"]:active,
input[type="submit"]:active,
input[type="file"]:active + label {
background-color: dodgerblue;
}

button:hover,
input[type="button"]:hover,
input[type="submit"]:hover,
input[type="file"]:hover + label {
    box-shadow: 0 0 2px 1px dodgerblue;
}

h1 {
  text-align: center;
}
.audio-only-container {
    display: flex;
    align-items: center;
}
.audio-only-button {
    height: 35px;
    width: 179px;
    font-size: 1em;
    border-radius: 10px;
    border: 1px solid #00AA00;
}
.audio-only-container p {
    margin-right: 10px; /* Adjust as needed for spacing */
}
.convert-audio-button {
    background-color: red;
    height: 40px;
    width: 190px;
    font-size: x-large;
    border-radius: 10px;
    margin-bottom: 20px;
}
.convert-audio-button.available {
    background-color: forestgreen;
}
.audio-only-window {
    visibility: hidden;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #202020;
    color: #FFFFFF;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    z-index: 100;
    box-shadow: 6px 10px 10px rgba(0, 0, 0, 0.9);
    transition: opacity 0.25s ease-in-out;
    opacity: 0; /* Initially transparent */
    width: 665px; /* Fixed width */
    height: 465px; /* Fixed height */
    overflow: auto; /* Add scroll for overflow content */
}
#audioOnlyWindow p:nth-of-type(2) {
    height: 45px; /* Set a fixed height */
    overflow: hidden; /* Hide overflow text */
}
/* Visible and faded-in state */
.audio-only-window.visible {
    visibility: visible;
    opacity: 1;
/*    transition-delay: 0s;*/
}
.centered-header {
    text-align: center;
}
.audio-file-input-container {
    display: flex;
}
.audio-file-input-button {
    background-color: forestgreen;
    height: 40px;
    width: 140px;
    font-size: large;
    border-radius: 10px;
/*    padding: 10px;*/
/*    background-color: #4CAF50;*/
/*    color: white;*/
/*    border: none;*/
    border-radius: 10px;
    cursor: pointer;
}
/*.audio-file-input-button.available {
    background-color: forestgreen;
}*/
.audio-file-info-display {
    min-width: 220px;
    max-width: none%;
    white-space: pre;
    text-align: center; /* Default center alignment */
    margin-left: 10px;
    background-color: #555;
    color: #fff;
    border: 1px solid #777;
    border-radius: 2px;
    box-shadow: 0 0 0 1px transparent;
/*    cursor: not-allowed;*/
}
.audio-file-info-display:hover {
    box-shadow: 0 0 0 1px transparent !important;
}
.audio-file-info-display:active {
    background-color: #555 !important;
}
.audio-file-info-display.files-chosen {
    text-align: left;
}


/* New class for the button when it's clicked */
.convert-audio-button.clicked {
    background-color: dodgerblue;
}
/* Style for the close button */
.close-button {
    float: right;
    border: none;
    background-color: transparent;
    color: red;
    font-size: 20px;
    cursor: pointer;
}
.dont-show-label {
    display: block;
    margin-top: 5px;
    color: white;
    font-size: 14px;
}

.dont-show-label input {
    margin-right: 5px;
    vertical-align: middle;
}
.optimize-checkbox, .optimize-label {
    display: none;
}
.optimize-checkbox.show, .optimize-label.show {
    display: inline-block;
}

/*.multiple-fonts-checkbox-container {
    display: flex;
    align-items: center;
}*/
.file-input-container {
    display: flex;
}
.file-input-button {
    background-color: red;
    height: 40px;
    width: 140px;
    font-size: large;
    border-radius: 10px;
/*    padding: 10px;*/
/*    background-color: #4CAF50;*/
/*    color: white;*/
/*    border: none;*/
    border-radius: 10px;
    cursor: pointer;
}
.file-input-button.available {
    background-color: forestgreen;
}
.file-info-display {
    min-width: 220px;
    max-width: none%;
    white-space: pre;
    text-align: center; /* Default center alignment */
    margin-left: 10px;
    background-color: #555;
    color: #fff;
    border: 1px solid #777;
    border-radius: 2px;
    box-shadow: 0 0 0 1px transparent;
/*    cursor: not-allowed;*/
}
.file-info-display:hover {
    box-shadow: 0 0 0 1px transparent !important;
}
.file-info-display:active {
    background-color: #555 !important;
}
.file-info-display.files-chosen {
    text-align: left;
}

.rename-button {
    background-color: red;
    height: 40px;
    width: 140px;
    font-size: x-large;
    border-radius: 10px;
    margin-bottom: 20px;
}
.rename-button.available {
    background-color: forestgreen;
}

.log-stream {
    height: 250px;
    width: 97%;
    font-size: small;
    border: 1px solid #00AA00;
    overflow-y: scroll
}

.download-button {
    display: none;
    background-color: yellow;
    color: black;
    padding: 10px;
    border-width: thick;
    border-radius: 10px;
    width: 275px; /* Fixed width */
    font-size: 18px; /* Larger font size */
    text-align: center; /* Center the text */
}
.download-button.show {
    display: block;
}
.download-button.active {
    background-color: dodgerblue;
    color: white;
}

/* Footer */
.footer-title {
    min-width: 180px;
    font-size: 16px;
    padding-left: 10px;
}
.footer-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #333;
    padding: 6px 0px;
}
/*Version Changelog button*/
.footer-button {
    background-color: black;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    display: inline-block;
    padding: 4px;
    margin-bottom: 2px;
}

.other-sites {
    float: right;
    padding-right: 10px;
    margin-left: 35px;
}
.footer-links {
    display: flex;
    align-items: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 100px;
}
.footer-links a img {
    height: 16px;
    width: 16px;
/*    margin-right: 5px;*/
    padding-right: 10px;

}
.footer-links a:hover {
    color: #000;
}
.donate-button {
    width: 170px;
/*    height: auto;*/
    padding-top: 3px;
}
    </style>
<body>
    <div id="popup" class="popup">
    <button id="popupCloseButton" class="close-button">&#10006;</button>
        <label class="dont-show-label">
            <input type="checkbox" id="dontShowAgain">
            <span>Don't show this on page load</span>
        </label>
    <div id="popupContent">
        <h2>Version Changelog</h2>

        <p>[4.3.4]<br>
        <strong>Fixed</strong><br>
        &bull; Fixed mp3 conversion bug.<br>
        &bull; Fixed high-pass bug.<br>
        </p>

        <p>[4.3.3]<br>
        <strong>Fixed</strong><br>
        &bull; Fixed logging for Audio Conversion.<br>
        </p>

        <p>[4.3.2]<br>
        <strong>Fixed</strong><br>
        &bull; Fixed Sample Rate conversion error.<br>
        </p>

        <p>[4.3.1]<br>
        <strong>Added</strong><br>
        &bull; Version Changelog popup.<br>
        &bull; BC Style Editor link in Other Sites section.<br>
        </p>

        <p>[4.3.0]<br>
        <strong>Added</strong><br>
        &bull; Dedicated Golden Harvest naming instead of suggesting to just use CFX naming.<br>
        &bull; Add Golden Harvest settings.txt to the font folder in the process.<br>
        &bull; Timestamp to Conversion_log.txt.<br>
        <strong>Changed</strong><br>
        &bull; Changed GH3 to just Golden Harvest, as there’s now a GH4 as well that uses the same convention.<br>
        &bull; Changed board dropdown menus to mixed instead of all CAPS.<br>
        &bull; Changed “Convert” to “Rename” throughout, except Convert Audio, because that is actual conversion.<br>
        &bull; Verso: Changed any extra font files to fontALT instead of boot files.<br>
        <strong>Fixed</strong><br>
        &bull; Fixed status text that wasn’t showing the source font folder name.<br>
        &bull; Fixed Semantic Versioning of this project!<br>
        </p>

        <p>[4.2.1]<br>
        <strong>Fixed</strong><br>
        &bull; Fixed optimization checkbox hover tips.<br>
        </p>

        <p>[4.2.0]<br>
        <strong>Added</strong><br>
        &bull; Optional Enable High Pass filter to both renaming and audio convert only routines.<br>
        &bull; Automatically apply 40 sample fade-in and fade-out to front and end of WAVs to prevent clicking.<br>
        &bull; Automatically scroll to bottom to reveal Download button when ready.<br>
        </p>

        <p>[4.1.1]<br>
        <strong>Added</strong><br>
        &bull; Metadata tags are automatically removed (Artist, Title, Genre etc...)<br>
        </p>

        <p>[4.1.0]<br>
        <strong>Added</strong><br>
        &bull; Support for mp4 video files!<br>
        &nbsp;&nbsp; Audio will be grabbed from video files and converted to ideal .wav format as well.<br>
        &bull; Specific Golden Harvest naming fixes.<br>
        &bull; CFX results now properly do not number the first blaster.wav file.<br>
        &bull; Tracks, extras, bonus etc… files no longer changed to all lowercase.<br>
        &bull; Verso 2.0 support - also add blast1.wav for blaster firing sound.<br>

        <p>[4.0.0]<br>
        <strong>Added</strong><br>
        &bull; Support for .mp3 files. They will be converted to ideal .wav format.<br>
        &bull; Stand-alone audio converter without renaming or restructuring anything with the "Convert Audio Only" button up top.<br>
        &nbsp;&nbsp; Download starts automatically when finished.<br>
        &bull; "Multiple Fonts" checkbox allows for selecting a folder of font folders to be processed.<br>
        &nbsp;&nbsp; This applies automatically to Audio Only conversions.<br>
        &bull; Proffie: Support for Alt, sub-sub, and "tr" sounds.<br>
        <strong>Changed</strong><br>
        &bull; File chooser interface customized to reflect when available / unavailable, with chosen folder details shown.<br>
        <strong>Fixed</strong><br>
        &bull; Better handling of tracks, "extra" or "bonus" material.<br>
        &bull; Improved logging.<br>
        </p>

        <p>[3.1.0]<br>
        <strong>Added</strong><br>
        &bull; Audio is automatically checked and converted to proper specs if needed. (44.1kHz, 16bit, monaural .wav file)<br>
        &bull; Add multiple download slots to allow for concurrent users.<br>
        &bull; Remove uploaded and zipped files after 3 minutes instead of at next conversion.<br>
        &bull; Processed files are sorted in expected order to retain same file numbers on output.<br>
        &bull; Downloaded font folder is labeled as font_board (so like Dooku_PROFFIE) to avoid mixing your fonts up.<br>
        &bull; GUI improvements:<br>
        &nbsp;&nbsp; Live, scrollable log view of conversion process.<br>
        &nbsp;&nbsp; Log output is written to a Conversion Log and is included with the converted font.<br>
        &nbsp;&nbsp; Separate upload and progress bars just because.<br>
        <strong>Changed</strong><br>
        &bull; Proffie Optimizer button hidden when not applicable.<br>
        &bull; GUI improvements:<br>
        &nbsp;&nbsp; Convert button shows availability with red or green. Larger too.<br>
        &nbsp;&nbsp; Larger, colorful download button is removed when download expires.<br>
        &nbsp;&nbsp; Dynamic Download button text.<br>
        &nbsp;&nbsp; More informative progress bar text including font name, source and target board, upload and download status, and error messages.<br>
        &nbsp;&nbsp; Tool tip changes depending on Optimize for Proffie checkbox enabled or not.<br>
        </p>

        <p>[3.0.0]<br>
        <strong>Added</strong><br>
        &bull; Proffie: Adds missing default config.ini and smoothsw.ini files.<br>
        </p>
    </div>
</div>

<div class="content-container">
    <h1>Welcome to the Sound Font Naming Converter 4.3.4</h1>

    <form id="audioForm" action="/audioConvert" method="post" enctype="multipart/form-data">

        <!-- Button to show the floating window -->
        <div class="audio-only-container">
            <button type="button" id="audioOnlyButton" class="audio-only-button">Convert Audio Only</button>
        </div>
        <!-- Floating window (initially hidden) -->
        <div id="audioOnlyWindow" class="audio-only-window">
            <!-- Red X button     -->
            <button id="closeButton" class="close-button">&#10006;</button>
                <h2 class="centered-header">Convert font to<br>44.1khz 16 bit monaural PCM WAV files.</h2>
                <br>
                <p>Add the folder(s) of sounds you wish to convert.</p>
                <div id="audioFileInputContainer" class="audio-file-input-container">
                    <div>
                        <input type="file" id="audioFiles" name="audioFiles" webkitdirectory directory multiple style="display:none;">
                        <button id="audioFileInputButton" class="audio-file-input-button" title="Upload files">Upload Files</button>
                    </div>
                    <!-- <div id="fileInfoDisplay" class="file-info-display"> -->
                    <input type="button" id="audioFileInfoDisplay" class="audio-file-info-display" value="No files chosen" title="Uploaded files status." />
                </div>
                <br>
                <!-- Add High-Pass Filter Checkbox -->
                <div>
                    <input type="checkbox" id="audioHighPassCheckbox" name="applyHighPassCheckbox">
                    <label for="audioHighPassCheckbox">Enable High-Pass Filter</label>
                </div>

                <p>Click "Convert Audio" and then Download the resulting zip file to your computer. Files will be available for 3 minutes.</p>
                <input type="submit" value="Convert Audio" id="convertAudioButton" class="convert-audio-button" title="Convert selected font audio to 44.1khz 16 bit monaural PCM WAV files.">
                <div>
                <!-- audioProcessProgressBar and its status message -->
                    <p>Progress....</p>
                    <progress id="audioProcessProgressBar" class="audioProcessProgressBar" max="100" value="0" ></progress>
                </div>
        </div>
    </form>

    <!-- Message display for feedback -->
    <div th:if="${message}" th:text="${message}"></div>

    <p>1. Choose a source and target format from the drop down menus below.</p>
    <!-- Form to get user input -->
    <form id="uploadForm" action="/convert" method="post" enctype="multipart/form-data">
        <!-- Dropdown for source board selection -->
        <select id="sourceBoard" name="sourceBoard" title="Source board">
            <option value="CFX">CFX</option>
            <option value="GOLDEN_HARVEST">Golden Harvest</option>
            <option value="PROFFIE">Proffieboard</option>
            <option value="VERSO">Verso</option>
            <option value="XENO3">Xeno 3</option>
        </select>

        <!-- Dropdown for target board selection -->
        <select id="targetBoard" name="targetBoard" title="Target board">
            <option value="CFX">CFX</option>
            <option value="GOLDEN_HARVEST">Golden Harvest</option>
            <option value="PROFFIE">Proffieboard</option>
            <option value="VERSO">Verso</option>
            <option value="XENO3">Xeno 3</option>
        </select>

        <input type="checkbox" id="optimizeCheckbox" name="optimizeCheckbox" class="optimize-checkbox" value="true" checked>

        <label for="optimizeCheckbox" class="optimize-label">Optimize for FAT32 performance? You should ;)</label>
        <br>

        <br>

        <p>2. Add the font folder containing the files you wish to rename and choose options.</p>
        <!-- Checkbox for selecting multiple fonts -->
        <div id="multipleFontsCheckboxContainer" class="multiple-fonts-checkbox-container">
            <input type="checkbox" id="multipleFontsCheckbox" name="multipleFontsCheckbox">
            <label for="multipleFontsCheckbox">Multiple Fonts (hover mouse over this for important info)</label>
        </div>
        <br>

        <!-- Checkbox for enabling High-Pass Filter -->
        <div id="highPassCheckboxContainer" class="high-pass-checkbox-container">
            <input type="checkbox" id="renameHighPassCheckbox" name="applyHighPassCheckbox">
            <label for="renameHighPassCheckbox">Enable High-Pass Filter (reduces frequencies below 100 Hz to prevent distortion)</label>
        </div>
        <br>

        <div id="fileInputContainer" class="file-input-container">
            <!-- Directory input -->
            <div>
                <input type="file" id="files" name="files" webkitdirectory directory multiple style="display:none;">
                <button id="fileInputButton" class="file-input-button" title="Upload files">Upload Files</button>
            </div>

            <!-- <div id="fileInfoDisplay" class="file-info-display"> -->
            <input type="button" id="fileInfoDisplay" class="file-info-display" value="No files chosen" title="Uploaded files status." />
        </div>


        <br>
        <p>3. Click "Rename" and then Download the resulting zip file to your computer.<br>&nbsp;&nbsp;&nbsp;&nbsp;Files will be available for 3 minutes.</p>

        <!-- Rename button -->
        <input type="submit" value="Rename" id="renameInput" class="rename-button" title="Rename selected files in font folder." >

        <!-- uploadProgressBar and its status message -->
        <div>
            <p>Upload status:</p>
            <progress id="uploadProgressBar" class="uploadProgressBar" max="100" value="0" ></progress>
            <p id="uploadProgressStatus"></p>
        </div>

 <!-- Live log window -->
<div id="conversionLogStream" class="log-stream">
    <p>Please Read Me!<br>
    Automated renaming of saber sound font sound file names between popular controller boards:<br>
    Proffieboard, CFX, Golden Harvest, Verso, and Xenopixel 3.<br>
    No need to manually rename a font (or many fonts) so it can be used on a different platform. Just click and done.</p>
    <p>Automatically converts audio files if the source is not in optimal 44.1kHz, 16 bit, monaural PCM WAV file format.<br>
    <p>Automatically applies a 40 sample fade-in and fade-out to front and end of wavs to prevent clicking.<br>
    <p>Includes an option to process multiple font folders at once.<br>
    <p>Includes an optional High Pass filter in both renaming and audio convert only routines to prevent distorion.<br>
    <p>Proffie to Proffie process organizes and renames a ProffieOS sound font for the best performance when used on FAT32 formatted media.<br>
        The Optimize checkbox is also on by default for other boards to Proffie conversions, but can be turned off. (but why?)</p>

    <p>Usage: Super easy. Barely an inconvenience.</p>
    <ul>
        <li>Choose a source and target sound board format.</li>
        <li>Choose a font folder from your local computer.</li>
        <li>Click the Rename button.</li>
        <li>Click the resulting Download button to retrieve a zip file containing the newly named font files.</li>
    </ul>

    <p>If this tool helped you, donations are appreciated ;) <a href="https://www.buymeacoffee.com/brianconner">Buy me a coffee</a></p>
</div>


<script>
    const eventSource = new EventSource('/stream-conversion-logs');
    let firstMessageReceived = false;

    eventSource.onmessage = function(event) {
//    console.log('Received SSE Message:', event.data); // Debugging line
        const logStreamDiv = document.getElementById('conversionLogStream');

        // Check if the message is a command to clear logs
        if (event.data === 'CLEAR_LOGS') {
            // Clear the log display element
            logStreamDiv.innerHTML = '';
        } else {
            // Otherwise, append the message to the log display element
            logStreamDiv.innerHTML += event.data + '<br>';
            logStreamDiv.scrollTop = logStreamDiv.scrollHeight; // Auto-scroll to the bottom
        }
    };
</script>
        <div>
        <!-- processProgressBar and its status message -->
            <p>Progress....</p>
            <progress id="processProgressBar" class="processProgressBar" max="100" value="0" ></progress>
            <p id="processProgressStatus">Waiting for files to be uploaded. Choose Files and click 'Rename'.</p>
        </div>

        <!-- Download button (Hidden initially) -->
        <input type="button" id="downloadButton" class="download-button" value="Download Renamed Files" title="Download renamed font." />

</div>  
        <div class="footer-container">
          <span class="footer-title">NoSloppy - 2025</span>

          <!-- <button id="versionChangelogButton" class="footer-button" title="View the version changelog">Version Changelog</button> -->
          <button id="versionChangelogButton" class="footer-button" title="View the version changelog" type="button">Version Changelog</button>

        <a href="https://www.buymeacoffee.com/BrianConner" title="Brian Conner supports the saber community. Support him back.">
            <img class="donate-button" src="/donateButton.jpg"></a>

          <span class="footer-links">
            <span class="other-sites">Other sites: </span>
            <a href="https://nosloppy.github.io/ProffieOS-StyleEditor-1/style_editor_BC_V6.html" target="_blank"title="BC Style Editor"><img src="https://nosloppy.github.io/ProffieOS-StyleEditor-1/SE_Favicon.png" alt="BC Style Editor logo"></a>
            <a href="https://crucible.hubbe.net/" target="_blank" title="The Crucible"><img src="https://crucible.hubbe.net/uploads/default/optimized/1X/2237f551ca8f4f69ac478df5c64aee1c951c33f5_2_180x180.png" alt="Crucible logo"></a>
            <a href="https://pod.hubbe.net/" target="_blank" title="ProffieOS Documentation site" ><img src="https://pod.hubbe.net/images/favicon.png" alt="Pod logo"></a>
            <a href="https://fredrik.hubbe.net/lightsaber/" target="_blank" title="Profezzorn's Proffieboard site"><img src="https://fredrik.hubbe.net/favicon.ico" alt="Lightsaber logo"></a>
            <a href="https://www.fett263.com/" target="_blank" title="Fett263's Style Library"><img src="https://www.fett263.com//favicon.ico" alt="Fett263 logo"></a>
            <a href="https://www.facebook.com/groups/opensourcesabers/" target="_blank" title="Open Source Group"><img src="https://www.facebook.com/favicon.ico" alt="Facebook logo"></a>
            <a href="https://crystalfocus.net/" target="_blank" title="crystalfocus.net"><img src="https://crystalfocus.net/images/logo.ico" alt="crystalfocus.net logo"></a>
            <a href="https://https://sabertec.net/" target="_blank" title="https://sabertec.net"><img src="https://sabertec.net/wp-content/uploads/2016/12/cropped-Logo-Sabertec-Bildmarke-V2-Hintergrund-32x32.png" alt="https://sabertec.net logo"></a>
            <a href="https://darkwolfsabers.com/" target="_blank" title="darkwolfsabers.com"><img src="https://img1.wsimg.com/isteam/ip/494b9647-5ed3-4359-92d3-188572d6d1f1/favicon/95b2b868-5641-4853-8c6d-057e8ebf1d55.jpeg/:/rs=w:16,h:16,m" alt="darkwolfsabers.com logo"></a>

          </span>
        </div>
    </form>
<script>
    let isSanitary_ = false;
    let downloadReady_ = false;
    let sourceDirName = "";
    let showed_popup_ = false;
    let server_full_ = false;
    let downloadTimeoutId = null;
    let processIntervalId = null;
    let processProgressValue = 0;
    let audioProcessIntervalId = null;
    let audioProcessProgressValue = 0;
    let both_proffie_ = false;
    let shouldOpenFileDialog = false;

    const popup = document.getElementById('popup');
    const popupCloseButton = document.getElementById('popupCloseButton');
    const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
    const versionChangelogButton = document.getElementById('versionChangelogButton');

    const sourceBoard = document.getElementById('sourceBoard');
    const targetBoard = document.getElementById('targetBoard');

    const fileInput = document.getElementById('files');
    const fileInputButton = document.getElementById('fileInputButton');
    const fileInfoDisplay = document.getElementById('fileInfoDisplay');
    let selectedFiles = fileInput.files;

    const audioOnlyWindow = document.getElementById('audioOnlyWindow');
    const audioFileInput = document.getElementById('audioFiles');
    const audioFileInputButton = document.getElementById('audioFileInputButton');
    const audioFileInfoDisplay = document.getElementById('audioFileInfoDisplay');
    const audioHighPassCheckbox = document.getElementById('audioHighPassCheckbox');
    let audioSelectedFiles = audioFileInput.files;
    const closeButton = document.getElementById('closeButton');

    const optimizeCheckbox = document.getElementById('optimizeCheckbox');
    const downloadButton = document.getElementById('downloadButton');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const processProgressBar = document.getElementById('processProgressBar');
    const processProgressStatus = document.getElementById('processProgressStatus');
    const audioProcessProgressBar = document.getElementById('audioProcessProgressBar');
    const audioProcessProgressStatus = document.getElementById('audioProcessProgressStatus');

    const multipleFontsCheckbox = document.getElementById('multipleFontsCheckbox');
    const multipleFontsCheckboxContainer = document.getElementById('multipleFontsCheckboxContainer');
    let isMultipleFonts = false;
    const renameHighPassCheckbox = document.getElementById('renameHighPassCheckbox');

    let fontFolders = new Map();
    let dirIdentifier = '';

    const form = document.getElementById('uploadForm');
    const audioForm = document.getElementById('audioForm');

    const renameButton = document.getElementById('renameInput');
    const convertAudioButton = document.getElementById('convertAudioButton');
    const audioOnlyButton = document.getElementById('audioOnlyButton');

    var optimizeLabel = document.querySelector('label[for="optimizeCheckbox"]');


    document.addEventListener('DOMContentLoaded', function () {
        closeButton.click();
        fileInputButton.classList.remove('available');

        // Check localStorage to determine if the popup should be shown
        const dontShowAgainFlag = localStorage.getItem('dontShowChangelog');
        if (dontShowAgainFlag === 'true') {
            dontShowAgainCheckbox.checked = true;
        } else {
            popup.classList.add('show');
        }

        popupCloseButton.addEventListener('click', function () {
            popup.classList.remove('show');
            localStorage.setItem('dontShowChangelog', dontShowAgainCheckbox.checked ? 'true' : 'false');
        });

        dontShowAgainCheckbox.addEventListener('change', function () {
            localStorage.setItem('dontShowChangelog', this.checked ? 'true' : 'false');
        });
        versionChangelogButton.addEventListener('click', function () {
            dontShowAgainCheckbox.checked = localStorage.getItem('dontShowChangelog') === 'true';
            popup.classList.add('show');
        });

    });

    const updateTitles = () => {
        const elementsToUpdate = [optimizeCheckbox, optimizeLabel];
        if (!optimizeCheckbox.checked) {
            elementsToUpdate.forEach((element) => {
                element.setAttribute("title", "Organizes and renames an existing ProffieOS sound font for the best performance when used on FAT32 formatted media.\nThis feature is ON by default.\nYou need to uncheck it to bypass.");
            });
        } else {
            elementsToUpdate.forEach((element) => {
                element.setAttribute("title", "Proffie font optimization ON! Good choice ;)");
            });
        }
        if (optimizeCheckbox.disabled) {
            elementsToUpdate.forEach((element) => {
                element.setAttribute("title", "You've chosen Proffie to Proffie, this feature can not be disabled.");
            });
        }
    };

    audioOnlyButton.setAttribute("title", "Convert font to 44.1khz 16 bit monaural PCM WAV files.\nNo renaming of files.");
    multipleFontsCheckboxContainer.setAttribute("title", "Multiple Fonts ON will process a folder containing multiple font folders.\nUnderstand that every immediate subfolder of the one you submit will be processed as an individual font.\nIf a folder containing multiple font folders is submitted and this checkbox is left OFF, all fonts within will be converged into one über font.");

    // Initialize titles on page load
     updateTitles(targetBoard);

    audioOnlyButton.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default form submission
        audioOnlyWindow.classList.add('visible');
    });


    sourceBoard.addEventListener('change', function(event) {
        renameButton.classList.remove('available');
        fileInput.value = '';
        fileInfoDisplay.value = "No files chosen";
        fileInfoDisplay.classList.remove('files-chosen');
        checkIfBoardsAreSame();
        if (targetBoard.value === "PROFFIE") {
            if (sourceBoard.value === "PROFFIE") {
                optimizeCheckbox.checked = true;
                optimizeCheckbox.disabled = true;
            } else {
                optimizeCheckbox.disabled = false;
            }
        }
        updateTitles();
    });


    targetBoard.addEventListener('change', function(event) {
        resetMessage(targetBoard);
showed_popup_ = false;
        checkIfBoardsAreSame();
        if (targetBoard.value === "PROFFIE") {
            showOptimizeUI();
            if (sourceBoard.value === "PROFFIE") {
                optimizeCheckbox.checked = true;
                optimizeCheckbox.disabled = true;
                updateTitles();
            }
        } else {
            hideOptimizeUI();
        }
    });

    function checkIfBoardsAreSame() {
        shouldOpenFileDialog = !(sourceBoard.value === targetBoard.value && sourceBoard.value !== "PROFFIE");
        console.log("sourceBoard.value = ", sourceBoard.value, " - targetBoard.value = ", targetBoard.value);

        if (sourceBoard.value === "CFX" && targetBoard.value === "PROFFIE") {
            if (!showed_popup_) {
                setTimeout(() => {
                    alert("Renaming from CFX to Proffie is not required.\nProffieboards already natively support Plecter fonts.\nHowever, you can continue anyway.");
                }, 100);
                    showed_popup_ = true;
            }
            shouldOpenFileDialog = true;
            console.log("selectedFiles.length = ? ", selectedFiles.length);
            renameButton.classList[selectedFiles.length != 0 ? 'add' : 'remove']('available');

        } else if (sourceBoard.value === targetBoard.value) {
            if (sourceBoard.value === "PROFFIE") {
                both_proffie_ = true;
                optimizeCheckbox.checked = true;
                optimizeCheckbox.disabled = true;
                updateTitles();
                if (!showed_popup_) {
            setTimeout(() => {
                    alert("You've chosen Proffie to Proffie, which optimizes the folder structure for best performance when using a FAT32 file system (which is what the SD card uses.)");
            }, 100);
                }
                showed_popup_ = true;
            shouldOpenFileDialog = true; // Allow file dialog when both are PROFFIE
            renameButton.classList.add('available');
            } else {
                both_proffie_ = false;
                optimizeCheckbox.disabled = false;
                updateTitles();// in background to follow not disabled
            setTimeout(() => {
                window.alert("Renaming from " + sourceBoard.value + " to " + targetBoard.value + " is unnecessary.\nPlease choose a different conversion.");
            }, 100);
                renameButton.classList.remove('available');
                shouldOpenFileDialog = false;
                // fileInput.value = '';
                // return;
            }
        } else {
            if (targetBoard.value != "PROFFIE") optimizeCheckbox.checked = false;
                if (targetBoard.value === "VERSO" && !showed_popup_) {
                    setTimeout(() => {
                        alert("Verso uses 'blaster firing' sounds before the 'deflection' sound, so a blast1.wav will be added for you.");
                    }, 100);
                    showed_popup_ = true;
                }
            shouldOpenFileDialog = true; // Allow file dialog when target board is not PROFFIE

        }
        renameButton.classList[(shouldOpenFileDialog && isSanitary_ && selectedFiles.length != 0) != 0 ? 'add' : 'remove']('available');
        //renameButton.classList.remove('available');
        fileInputButton.classList[shouldOpenFileDialog ? 'add' : 'remove']('available');
    }

   function showOptimizeUI() {
        optimizeCheckbox.classList.add('show');
        optimizeLabel.classList.add('show');
        optimizeCheckbox.checked = true;
    }
    function hideOptimizeUI() {
        optimizeCheckbox.classList.remove('show');
        optimizeLabel.classList.remove('show');
    }

    optimizeCheckbox.addEventListener('change', function(event) {
        updateTitles();
    });
    multipleFontsCheckbox.addEventListener('change', function(event) {
        if (this.checked) {
            console.log("Multiple Fonts turned ON.");
            setTimeout(() => {
                window.alert("Multiple Fonts ON will process a folder containing multiple font folders.\nUnderstand that every immediate subfolder of the one you submit will be processed as an individual font.\nIf a folder containing multiple font folders is submitted and this checkbox is left OFF, all fonts within will be converged into one über font.");
            }, 100);
        } else {
            console.log("Multiple Fonts OFF.");
        }
    });
    // Listener for the Audio-Only section checkbox
    audioHighPassCheckbox.addEventListener('change', function() {
        renameHighPassCheckbox.checked = this.checked; // Sync state
        console.log("High Pass Filter Checkbox: ", this.checked ? "ON" : "OFF");
    });
    // Listener for the Renaming section checkbox
    renameHighPassCheckbox.addEventListener('change', function() {
        audioHighPassCheckbox.checked = this.checked; // Sync state
        console.log("High Pass Filter Checkbox: ", this.checked ? "ON" : "OFF");
    });

// ------------------ AUDIO CONVERSION --------------------
            closeButton.addEventListener('click', function(event) {
                clearInterval(audioProcessIntervalId);
                audioProcessProgressBar.value = 0;
                audioFileInput.value = '';
                convertAudioButton.classList.add('available');
                document.querySelector('#audioOnlyWindow p:nth-of-type(2)').textContent = 'Click "Convert Audio" and then Download the resulting zip file to your computer.\nFiles will be available for 3 minutes.';
                this.classList.add('clicked');
                convertAudioButton.classList.remove('clicked');
                convertAudioButton.classList.remove('available');
                convertAudioButton.value = "Convert Audio";
                audioFileInfoDisplay.value = "No files chosen";
                audioFileInfoDisplay.classList.remove('files-chosen');
                event.preventDefault(); // Prevent default form submission
                audioOnlyWindow.classList.remove('visible');
            });

            // New Choose Audio (Upload) Files button
            audioFileInputButton.addEventListener('click', function(event) {
                event.preventDefault();
                audioFileInput.click();
            });

            // Choose Audio Files input (open files dialog)
            audioFileInput.addEventListener('change', function(event) {
                console.log("%%%%%%%% Choose Audio Files input - audioSelectedFiles.length = " + audioSelectedFiles.length);
                audioSelectedFiles = audioFileInput.files;
                if (audioSelectedFiles.length > 0) {
                    const folderName = audioSelectedFiles[0].webkitRelativePath.split('/')[0];
                    if (checkSanitary(folderName)) {
                        audioFileInfoDisplay.value = `Chosen folder: ${folderName}\n# of files selected: ${audioSelectedFiles.length}`;
                        audioFileInfoDisplay.classList.add('files-chosen');
                        convertAudioButton.classList.add('available');
                    } else {
                        audioFileInput.value = ''; // Clear the file input to force the user to choose again
                        audioFileInfoDisplay.value = "Invalid folder name. Please rename folder and try again.";
                        audioFileInfoDisplay.classList.remove('files-chosen');
                        convertAudioButton.classList.remove('available');
                    }
                } else {
                    audioFileInfoDisplay.value = "No files chosen";
                    audioFileInfoDisplay.classList.remove('files-chosen');
                    convertAudioButton.classList.remove('available');
                }
                document.querySelector('#audioOnlyWindow p:nth-of-type(2)').textContent = 'Click "Convert Audio" and then Download the resulting zip file to your computer.\nFiles will be available for 3 minutes.';
                this.classList.remove('clicked');
            });

            // Convert Audio button
            audioForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (audioSelectedFiles.length === 0) {
                    alert("No files selected. Please choose files before starting the conversion.");
                    convertAudioButton.classList.remove('clicked');
                    convertAudioButton.classList.remove('available');
                    return;
                }
                convertAudioButton.classList.add('clicked');
                convertAudioButton.value = "Converting...";
                document.querySelector('#audioOnlyWindow p:nth-of-type(2)').textContent = 'Converting. Please standby for download...';
                this.classList.add('clicked');
                updateAudioOnlyProgressBar();

                const formData = new FormData();
                for (let i = 0; i < audioSelectedFiles.length; i++) {
                    formData.append('audioFiles', audioSelectedFiles[i]);
                    // Append the webkitRelativePath as a separate field- why? only needs paths.
                    formData.append('filePaths', audioSelectedFiles[i].webkitRelativePath);
                }

                // Add High-Pass Filter Checkbox Value
                // Check the state of either checkbox
                const highPassValue =
                  (audioHighPassCheckbox && audioHighPassCheckbox.checked) ||
                  (renameHighPassCheckbox && renameHighPassCheckbox.checked) ? 'on' : null;

                // Append the High-Pass Filter value to formData
                formData.append('applyHighPassCheckbox', highPassValue);


                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/audioConvert', true);
                xhr.setRequestHeader("Accept", "application/json");

                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log("Audio conversion successful");
                        const blob = new Blob([xhr.response], { type: 'application/zip' });
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = "Converted_Audio_44.1.zip"; // Filename for download
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setTimeout(() => {
                            document.getElementById('closeButton').click();
                        }, 2000);  // 2000 milliseconds = 2 seconds
                    } else {
                        // For binary responses, the status code is the primary error indicator
                        console.error("Audio conversion failed. Status: " + xhr.status);
                    }
                };
                xhr.responseType = 'blob'; // Important to handle binary data

            // // Logging each file in FormData
            // for (let [key, value] of formData.entries()) {
            //     console.log("++Logging each file in FormData: ");
            //     console.log(`${key}: ${value instanceof File ? value.name : value}`);
            // }

                xhr.send(formData);
            });
// -------------------------------------------------------------------

function checkSanitary(folderName) {
    const specialChars = /[&^'()´`~!@#$%^&*?<>]/g; // Existing special character checks
    const specificUnicodeChars = /[\u202F\u00A0]/g; // Specific Unicode characters like narrow no-break space (\u202F) and non-breaking space (\u00A0)
    const nonAsciiChars = /[^\x00-\x7F]/g; // Catch any non-ASCII character

    if (specialChars.test(folderName) || specificUnicodeChars.test(folderName) || nonAsciiChars.test(folderName)) {
        alert("Folder names cannot contain special characters, non-ASCII characters, or certain Unicode characters.\nIt shouldn't really contain spaces either.\nPlease rename the source folder before uploading.");
        isSanitary_ = false;
        return false;
    }

    isSanitary_ = true;
    return true;
}

    // New Choose (Upload) Files button
    fileInputButton.addEventListener('click', function(event) {
        renameButton.classList.remove('available');
        event.preventDefault();
        resetMessage(targetBoard);
        checkIfBoardsAreSame(event);
        if (shouldOpenFileDialog) {
            fileInput.click();
        }
    });

// Choose Files input (open files dialog)
fileInput.addEventListener('change', function(event) {
    selectedFiles = fileInput.files;
    // Assume not sanitary by default each time files are chosen
    isSanitary_ = false; // Reset to false to ensure validation is performed again

    if (selectedFiles.length > 0) {
        const folderName = selectedFiles[0].webkitRelativePath.split('/')[0];
        if (checkSanitary(folderName)) {
            fileInfoDisplay.value = `Chosen folder: ${folderName}\n# of files selected: ${selectedFiles.length}`;
            fileInfoDisplay.classList.add('files-chosen');
            renameButton.classList.add('available');
        } else {
            fileInput.value = ''; // Clear the file input to force the user to choose again
            fileInfoDisplay.value = "Invalid folder name. Please rename folder and try again.";
            fileInfoDisplay.classList.add('files-chosen');
            renameButton.classList.remove('available');
            // Potentially clear file input here if you want to force the user to choose again
        }
    } else {
        fileInfoDisplay.value = "No files chosen";
        fileInfoDisplay.classList.remove('files-chosen');
        renameButton.classList.remove('available');
    }
});

    // Rename button
    form.addEventListener('submit', function(event) {
        console.log("optimizeCheckbox.checked = ", optimizeCheckbox.checked);
        console.log("selectedFiles.length = ", selectedFiles.length);
        processProgressBar.value = 0;
        checkIfBoardsAreSame();  // Check if target board has been changed to same board since choosing files
    if (!shouldOpenFileDialog) {
        event.preventDefault();
        return;
    }

  // Check if no files are selected
    if (selectedFiles.length === 0) {
        alert("No files selected. Please choose files before starting the conversion.");
        event.preventDefault(); // Prevent form submission
        return;
    }
    // Check if folder name is unsanitary
    if (!isSanitary_) {
        alert("Folder name contains disallowed characters.\nTry to avoid spaces too, it's just good practice.\nPlease rename the source folder before uploading.");
        renameButton.classList.remove('available');
        isSanitary_ = false;
        event.preventDefault(); // Prevent form submission
        return;
    }
        downloadReady_ = false;

    isMultipleFonts = multipleFontsCheckbox.checked; // Use the global variable
    console.log("Multiple Fonts Checkbox checked: ", isMultipleFonts);

// Check the state of both checkboxes
const isAudioHighPassEnabled = document.getElementById("audioHighPassCheckbox")?.checked || false; // Audio-only
const isRenameHighPassEnabled = document.getElementById("renameHighPassCheckbox")?.checked || false; // Renaming

// Log the states for debugging
console.log("Audio High-Pass Checkbox checked: ", isAudioHighPassEnabled);
console.log("Rename High-Pass Checkbox checked: ", isRenameHighPassEnabled);

// Determine if high-pass should be enabled for the current context
const isHighPassEnabled = isAudioHighPassEnabled || isRenameHighPassEnabled; 
console.log("High-Pass Filter enabled: ", isHighPassEnabled);


        if (isMultipleFonts) {
            // Process each font folder individually within the directory
            fontFolders.clear();
            Array.from(selectedFiles).forEach(file => {
                if (!/^\./.test(file.name)) { // Exclude dot files
                    const splitPath = file.webkitRelativePath.split('/');
                    if (splitPath.length > 1) {
                        const folderName = splitPath[1]; // Extract individual font folder name
                        if (!fontFolders.has(folderName)) {
                            fontFolders.set(folderName, []);
                        }
                        fontFolders.get(folderName).push(file);
                    }
                }
            });
        console.log("Grouped font folders:", fontFolders); // Log grouped font folders

            processNextFolder();
        } else {
            // Logic for handling a single font or merged fonts
            const topLevelFolderName = selectedFiles[0].webkitRelativePath.split('/')[0];
            // Filter out dot files before processing
            const filteredFiles = Array.from(selectedFiles).filter(file => !/^\./.test(file.name));
        // console.log("Processing single/merged font folder:", topLevelFolderName);
        processFontFolder(topLevelFolderName, filteredFiles, isMultipleFonts);
        }

        event.preventDefault();
    });

    function processNextFolder() {
        if (fontFolders.size > 0) {
            const currentFolder = fontFolders.keys().next().value;
            const filesToProcess = fontFolders.get(currentFolder);
            fontFolders.delete(currentFolder); // Remove the processed folder from the map
            processFontFolder(currentFolder, filesToProcess);
        } else {
            console.log("All font folders processed. Initiating finalization...");
            finalizeConversion();
        }
    }

        function sendFormData(formData) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/convert', true);
        xhr.setRequestHeader("Accept", "application/json");

    // Log the entire form data to the console before sending
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`); // Log each key-value pair
    }


        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                uploadProgressBar.value = percentComplete;
                if (percentComplete < 100) {
                    processProgressStatus.innerText = "Uploading files...";
                 } else {
                    if (optimizeCheckbox.checked && targetBoard.value === "PROFFIE") {
                        processProgressStatus.innerText = "Optimizing Proffie font for performance on FAT32 formatted SD card.\nFiles uploaded. Processing " + sourceDirName + " to " + targetBoard.value + " ...";
                    } else {
                        processProgressStatus.innerText = "Files uploaded. Renaming " + sourceDirName + " from " + sourceBoard.value + " to " + targetBoard.value + " ...\n\n";
                    }
                    updateProcessProgressBar();
                }
            }
        };


        // Server response
        xhr.onload = function() {
            if (xhr.status === 429) { // Check if the status code is 429
                server_full_ = true;
                const response = JSON.parse(this.responseText);
                processProgressStatus.innerText = response.message; // Show server full message
                resetMessage(targetBoard);
            } else if (xhr.status >= 200 && xhr.status < 300) {
                server_full_ = false;
                const response = JSON.parse(this.responseText);
            
                if (response.status === "fontProcessed") {
                    // console.log("A font folder processed successfully");
                    processNextFolder();
 
                } else if (response.status === "info") {
                    console.log('Response was info');
                    processProgressStatus.innerText = response.message;
                    downloadButton.classList.remove('show');
                } else {
                    console.log('Response was something else');
                    processProgressStatus.innerText = response.message;
                    downloadButton.classList.remove('show');
                }
            }
        };
        // Add High-Pass Filter Checkbox Value
        // Check the state of either checkbox
        const highPassValue =
          (audioHighPassCheckbox && audioHighPassCheckbox.checked) ||
          (renameHighPassCheckbox && renameHighPassCheckbox.checked) ? 'on' : null;

        // Append the High-Pass Filter value to formData
        formData.append('applyHighPassCheckbox', highPassValue);

        xhr.send(formData);
    }

    function isSafari() {
        return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    }

// Function to process a single font folder from a folder of multiple
function processFontFolder(folderName, files) {
    // console.log("Starting processFontFolder for folder:", folderName);
    const formData = new FormData();
    formData.append('sourceBoard', sourceBoard.value);
    formData.append('targetBoard', targetBoard.value);
    formData.append('optimizeCheckbox', optimizeCheckbox.checked ? 'true' : 'false');

    sourceDirName = folderName; // For multiple fonts, this will be each child folder name

    files.forEach(file => {
        if (!/^\./.test(file.name)) { // Exclude dot files
            let filePath = file.webkitRelativePath;
            // console.log("Original file path: ", filePath);

            // Adjust the file path if processing multiple fonts
            if (isMultipleFonts) {
                filePath = filePath.split('/').slice(1).join('/'); // Strip the top-level folder from the path
                // console.log("Adjusted file path for multiple fonts: ", filePath);
            }

            formData.append('files', file);
            formData.append('filePaths', filePath); // Use the adjusted filePath here
        }
    });

    // Append sourceDirName to formData. For single fonts, it uses the first segment of the path
    if (!isMultipleFonts) {
        sourceDirName = files[0].webkitRelativePath.split('/')[0];
    }
    formData.append('sourceDirName', sourceDirName);

    console.log("Processing Font Folder: ", folderName);
    // files.forEach(file => console.log("Processing file: ", file.webkitRelativePath));

    console.log("Is Safari: ", isSafari());

    // // Additional logging for FormData contents
    // for (let [key, value] of formData.entries()) {
    //     console.log(`FormData entry - Key: ${key}, Value: ${value instanceof File ? value.name : value}`);
    // }

    sendFormData(formData);
}
        // Logging each file in FormData
        // for (let [key, value] of formData.entries()) {
        //     console.log("++Logging each file in FormData: ");
        //     console.log(`${key}: ${value instanceof File ? value.name : value}`);
        // }

function finalizeConversion() {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/finalizeConversion`, true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.status === "success") {
                downloadButton.dataset.dirIdentifier = response.dirIdentifier;
                console.log("Finalization complete, Download ready.");
                downloadReady_ = true;
            }
        }
    };
    xhr.send();
}

    function updateAudioOnlyProgressBar() {
        // Clear any existing interval
        if (audioProcessIntervalId) clearInterval(audioProcessIntervalId);

        let startTime = Date.now();
        audioProcessIntervalId = setInterval(function() {
            let elapsedTime = Date.now() - startTime;

            // Check if animation reached the end and reset if necessary
            if (elapsedTime >= 2500) {
                startTime = Date.now(); // Reset startTime to restart animation
                elapsedTime = 0; // Reset elapsedTime
            }

            audioProcessProgressValue = Math.min(100, (elapsedTime / 2500) * 100);
            document.getElementById('audioProcessProgressBar').value = audioProcessProgressValue;
        }, 50);
    }

    function updateProcessProgressBar() {
        // Clear any existing interval and timeout
        if (processIntervalId) clearInterval(processIntervalId);
        if (downloadTimeoutId) clearTimeout(downloadTimeoutId);
        let startTime = Date.now();
        processIntervalId = setInterval(function() {
            let elapsedTime = Date.now() - startTime;
            // Check if animation reached the end and download isn't ready
            if (elapsedTime >= 2500 && !downloadReady_) {
                startTime = Date.now(); // Reset startTime to restart animation
                elapsedTime = 0; // Reset elapsedTime
            }
            if (!server_full_) {
                processProgressValue = Math.min(100, (elapsedTime / 2500) * 100); 
            } else {
                processProgressValue = 0;
            }
            if (elapsedTime >= 2000 && downloadReady_) {
                clearInterval(processIntervalId);
                processProgressBar.value = 100;
                downloadButton.classList.add('show');
                // Scroll the entire page to the bottom
                const contentContainer = document.querySelector('.content-container');
                contentContainer.scrollTo({ top: contentContainer.scrollHeight, behavior: 'smooth' });
                // Set a timer to hide the download button after 3 minutes
                downloadTimeoutId = setTimeout(() => {
                    downloadButton.classList.remove('show');
                    downloadButton.value = "Download Renamed Files";
                    processProgressStatus.innerText = "Download expired. Please start a new conversion.";
                },  180000);
                processProgressStatus.innerText = "Renaming of " + sourceDirName + " from " + sourceBoard.value + " to " + targetBoard.value + " complete.\nDownload will expire in 3 minutes.";
            } else {
                processProgressBar.value = processProgressValue;
            }
        }, 50);
    }


    downloadButton.addEventListener('click', function() {
        processProgressStatus.innerText = "Fetching renamed files. Standby for .zip download ...\n\n";
        const targetBoardValue = targetBoard.value;  // store this for later
        const dirIdentifier = downloadButton.dataset.dirIdentifier; // Retrieve dirIdentifier
        triggerDownload(targetBoardValue, dirIdentifier); // Pass dirIdentifier
    });

    function triggerDownload(targetBoard, dirIdentifier) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/downloadConvertedFiles?targetBoard=${targetBoard}&dirIdentifier=${dirIdentifier}`, true);
        xhr.responseType = 'blob';

        xhr.onloadstart = function() {
            // Download has started
            downloadButton.classList.add('active');
            downloadButton.value = "Downloading...";
        };

        xhr.onload = function() {
            if (this.status === 200) {
                const blob = this.response;
                const a = document.createElement('a');
                const url = window.URL.createObjectURL(blob);

                a.href = url;
                a.download = `Renamed_to_${targetBoard.toUpperCase()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                // Delay the reset of the UI elements by 2 seconds to hide color reset behind download window ¯\_(ツ)_/¯
                setTimeout(() => {
                        optimizeCheckbox.disabled = false;
                        updateTitles();
                        downloadButton.classList.remove('active');
                        downloadButton.value = "Re-Download Renamed Files";
                        if (optimizeCheckbox.checked && targetBoard.value === "PROFFIE") {
                            processProgressStatus.innerText = "Optimized Proffie font for performance on FAT32 formatted SD card.\nZIP file created and ready for download. Will expire in 3 minutes.";
                        } else {
                            processProgressStatus.innerText = "ZIP file created and ready for download. Will expire in 3 minutes.\n\n";
                        }
                }, 2000);  // 2000 milliseconds = 2 seconds
            } else {
                console.error('Failed to download file:', this.status, this.statusText);
                downloadButton.classList.remove('active');
                downloadButton.value = "Download Renamed Files";
            }
        };
        xhr.onerror = function() {
            // Handle any errors during download
            console.error('Error during download.');
            downloadButton.classList.remove('active');
            downloadButton.value = "Download Renamed Files";
        };
        xhr.send();
    }

    function resetMessage(targetBoard) {
        downloadButton.classList.remove('show');
        downloadButton.value = "Download Renamed Files";
        uploadProgressBar.value = 0;
        processProgressBar.value = 0;
        if (!server_full_ && !both_proffie_) {
            
            optimizeCheckbox.disabled = false;
            updateTitles();

            if (optimizeCheckbox.checked && targetBoard.value === "PROFFIE") {
                processProgressStatus.innerText = "Optimizing Proffie font for performance on FAT32 formatted SD card.\nWaiting for files to be uploaded. Choose Files and click 'Rename'.";
            } else {
                processProgressStatus.innerText = "Waiting for files to be uploaded. Choose Files and click 'Rename'.\n\n";
            }
        }
    }
</script>

</body>
</html>
